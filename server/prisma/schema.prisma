// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

// ==================== ENUMS ====================
enum user_role {
  PATIENT
  DOCTOR
  ADMIN
}

enum user_status {
  ACTIVE
  INACTIVE
  BANNED
}

enum gender {
  MALE
  FEMALE
  OTHER
}

enum appointment_status {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum appointment_type {
  ONLINE
  OFFLINE
}

enum sender_type {
  USER
  DOCTOR
  AI
}

// ==================== MODELS ====================

model users {
  id          Int         @id @default(autoincrement())
  full_name   String?     @db.VarChar(255)
  email       String?     @unique @db.VarChar(255)
  phone       String?     @unique @db.VarChar(20)
  password    String?     @db.VarChar(255)
  role        user_role   @default(PATIENT)
  status      user_status @default(ACTIVE)
  avatar_url  String?     @db.VarChar(500)

  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  deleted_at  DateTime?

  health_profile           health_profiles?
  doctor                   doctors?
  appointments_as_patient  appointments[] @relation("patient_appointments")
  medication_reminders     medication_reminders[]
  chat_sessions_as_patient chat_sessions[] @relation("patient_chats")

  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([status])
}

model health_profiles {
  user_id         Int       @id
  date_of_birth   DateTime?
  gender          gender?
  blood_type      String?   @db.VarChar(10)
  height_cm       Float?
  weight_kg       Float?
  allergies       String?   @db.Text
  medical_history String?   @db.Text

  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model specialties {
  id        Int      @id @default(autoincrement())
  name      String   @unique @db.VarChar(100)
  icon_url  String?  @db.VarChar(500)
  
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  doctors doctors[]
}

model doctors {
  user_id          Int      @id
  specialty_id     Int?
  hospital_name    String?  @db.VarChar(255)
  experience_years Int?
  fee_per_slot     Decimal  @db.Decimal(10, 2)
  is_verified      Boolean  @default(false)
  is_active        Boolean  @default(true)
  bio              String?  @db.Text
  
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  user            users        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  specialty       specialties? @relation(fields: [specialty_id], references: [id])

  appointments    appointments[]
  medical_records medical_records[]
  chat_sessions   chat_sessions[]

  @@index([specialty_id])
  @@index([is_verified])
  @@index([is_active])
}

model appointments {
  id          Int                @id @default(autoincrement())
  patient_id  Int
  doctor_id   Int
  start_time  DateTime
  end_time    DateTime
  type        appointment_type
  status      appointment_status @default(PENDING)
  reason      String?            @db.Text
  notes       String?            @db.Text
  timezone    String?            @default("Asia/Ho_Chi_Minh") @db.VarChar(50)

  created_at  DateTime           @default(now())
  updated_at  DateTime           @updatedAt
  deleted_at  DateTime?

  patient        users            @relation("patient_appointments", fields: [patient_id], references: [id])
  doctor         doctors          @relation(fields: [doctor_id], references: [user_id])
  medical_record medical_records?

  @@index([patient_id])
  @@index([doctor_id])
  @@index([start_time])
  @@index([status])
  @@index([type])
  @@index([created_at])
}

model medical_records {
  id             Int      @id @default(autoincrement())
  appointment_id Int      @unique
  doctor_id      Int
  diagnosis      String?  @db.Text
  treatment_plan String?  @db.Text
  notes          String?  @db.Text
  
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  appointment        appointments @relation(fields: [appointment_id], references: [id], onDelete: Cascade)
  doctor             doctors      @relation(fields: [doctor_id], references: [user_id])
  prescription_items prescription_items[]

  @@index([doctor_id])
  @@index([created_at])
}

model medicines {
  id           Int     @id @default(autoincrement())
  name         String  @db.VarChar(255)
  brand        String? @db.VarChar(255)
  category     String? @db.VarChar(100)
  unit         String? @db.VarChar(50)
  dosage_info  String? @db.Text
  side_effects String? @db.Text
  is_active    Boolean @default(true)

  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  prescription_items   prescription_items[]
  medication_reminders medication_reminders[]

  @@index([name])
  @@index([category])
  @@index([is_active])
}

model prescription_items {
  id                 Int     @id @default(autoincrement())
  medical_record_id  Int
  medicine_id        Int
  dosage_instruction String? @db.Text
  quantity           Int
  duration_days      Int
  
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  medical_record medical_records @relation(fields: [medical_record_id], references: [id], onDelete: Cascade)
  medicine       medicines       @relation(fields: [medicine_id], references: [id])

  @@index([medical_record_id])
  @@index([medicine_id])
}

model medication_reminders {
  id                Int      @id @default(autoincrement())
  user_id           Int
  medicine_id       Int
  time_reminder     DateTime
  frequency_per_day Int
  start_date        DateTime
  end_date          DateTime
  is_active         Boolean  @default(true)
  notes             String?  @db.Text

  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  user     users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  medicine medicines @relation(fields: [medicine_id], references: [id])

  @@index([user_id])
  @@index([medicine_id])
  @@index([time_reminder])
  @@index([is_active])
}

model chat_sessions {
  id         Int      @id @default(autoincrement())
  patient_id Int
  doctor_id  Int?
  is_ai_chat Boolean  @default(false)
  title      String?  @db.VarChar(255)
  is_active  Boolean  @default(true)
  
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  deleted_at DateTime?

  patient  users    @relation("patient_chats", fields: [patient_id], references: [id])
  doctor   doctors? @relation(fields: [doctor_id], references: [user_id])
  messages messages[]

  @@index([patient_id])
  @@index([doctor_id])
  @@index([is_ai_chat])
  @@index([created_at])
}

model messages {
  id          Int         @id @default(autoincrement())
  session_id  Int
  sender_type sender_type
  sender_id   Int?
  content     String?     @db.Text
  file_url    String?     @db.VarChar(500)
  is_read     Boolean     @default(false)
  
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  deleted_at  DateTime?

  session chat_sessions @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@index([session_id])
  @@index([sender_id])
  @@index([created_at])
  @@index([is_read])
}